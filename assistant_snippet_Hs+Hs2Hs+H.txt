# Custom range selection - set initial value based on edit mode
has_end_period = is_edit_mode and form_data.get('applied_end_quarter') is not None
is_custom_range = st.checkbox(
    f"Payment covers multiple {period_label.lower()}s",
    value=has_end_period,
    key="is_custom_range"
)

# Show custom range fields if enabled
end_period = start_period
end_year = start_year

if is_custom_range:
    st.markdown(f"##### Select {period_label} Range")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("From")
        start_period_option = st.selectbox(
            label=f"Start {period_label}",
            options=period_options,
            index=period_options.index(selected_period),
            key="custom_start_period",
            label_visibility="collapsed"
        )
        start_period, start_year = parse_period_option(start_period_option, contract[3])
    
    with col2:
        st.markdown("To")
        valid_end_options = [
            opt for opt in period_options
            if validate_period_range(
                start_period, start_year,
                *parse_period_option(opt, contract[3]),
                contract[3]
            )
        ] 